<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>CSS Cascade Control</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <meta content="exploring" name="csswg-work-status">
  <meta content="UD" name="w3c-status">
  <meta content="A proposal to improve the handling of list-value and set-valued properties when one wants to alter them in multiple independent ways, without overriding each other or having to explicitly handle all combinations." name="abstract">
  <link href="../default.css" rel="stylesheet" type="text/css">
  <link href="../csslogo.ico" rel="shortcut icon" type="image/x-icon">
  <link href="https://www.w3.org/StyleSheets/TR/2016/W3C-UD" rel="stylesheet" type="text/css">
  <meta content="Bikeshed version 090ef96cbce74475c89e94394cc8fa4fbc08b477" name="generator">
  <link href="https://tabatkins.github.io/specs/css-cascade-control/" rel="canonical">
  <meta content="1e172f762057e3faac49f08651499e505de4e9aa" name="document-revision">
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: gray;
    color: white;
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: black;
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: #005a9c;
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-dfn-panel */

.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: #DDDDDD;
    color: black;
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: black; }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-syntax-highlighting */

.highlight:not(.idl) { background: hsl(24, 20%, 95%); }
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">CSS Cascade Control</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="subtitle"><span class="content">Unofficial Proposal Draft, <time class="dt-updated" datetime="2018-09-14">14 September 2018</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://tabatkins.github.io/specs/css-cascade-control/">https://tabatkins.github.io/specs/css-cascade-control/</a>
     <dt>Issue Tracking:
     <dd><a href="#issues-index">Inline In Spec</a>
     <dd><a href="https://github.com/w3c/csswg-drafts/labels/css-cascade-control-1">GitHub Issues</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><span class="p-name fn">Tab Atkins-Bittner</span>
     <dt>Suggest an Edit for this Spec:
     <dd><a href="https://github.com/w3c/csswg-drafts/blob/master/css-cascade-control-1/Overview.bs">GitHub Editor</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2018 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>). W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/2015/copyright-software-and-document">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>A proposal to improve the handling of list-value and set-valued properties when one wants to alter them in multiple independent ways, without overriding each other or having to explicitly handle all combinations.</p>
    <a href="http://www.w3.org/TR/CSS/">CSS</a> is a language for describing the rendering of structured documents
(such as HTML and XML)
on screen, on paper, in speech, etc.
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#cascade-declarations"><span class="secno">2</span> <span class="content">Cascade Declarations</span></a>
     <ol class="toc">
      <li><a href="#managing-order-explicitly-with-variables"><span class="secno">2.1</span> <span class="content">Managing Order Explicitly with Variables</span></a>
     </ol>
    <li><a href="#cascade-function"><span class="secno">3</span> <span class="content">cascade() Function</span></a>
    <li>
     <a href="#conformance"><span class="secno"></span> <span class="content"> Conformance</span></a>
     <ol class="toc">
      <li><a href="#document-conventions"><span class="secno"></span> <span class="content"> Document conventions</span></a>
      <li><a href="#conform-classes"><span class="secno"></span> <span class="content"> Conformance classes</span></a>
      <li>
       <a href="#conform-responsible"><span class="secno"></span> <span class="content"> Requirements for Responsible Implementation of CSS</span></a>
       <ol class="toc">
        <li><a href="#conform-partial"><span class="secno"></span> <span class="content"> Partial Implementations</span></a>
        <li><a href="#conform-future-proofing"><span class="secno"></span> <span class="content"> Implementations of Unstable and Proprietary Features</span></a>
        <li><a href="#conform-testing"><span class="secno"></span> <span class="content"> Implementations of CR-level Features</span></a>
       </ol>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>A number of CSS properties are list-valued (background, transition, etc) or set-valued (will-change, etc).
These can be difficult to manage in an application written by several authors
(or partially styled by indepedent libraries),
or even when there’s only a single author
that just wants to style an element in multiple independent ways.</p>
   <p>For example,
a particular class might do some <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-transforms-1/#propdef-transform" id="ref-for-propdef-transform">transform</a> work,
and thus want to set <a class="css" data-link-type="propdesc" href="https://drafts.csswg.org/css-will-change-1/#propdef-will-change" id="ref-for-propdef-will-change">will-change: transform</a>,
while another class does some <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-color-4/#propdef-opacity" id="ref-for-propdef-opacity">opacity</a> changes,
and thus wants to set <span class="css">will-change: opacity</span>.
Done naively, if these two classes get set at the same time,
one will win over the other,
and <span class="property">will-change</span> will only reflect one of the values.</p>
   <p>Currently, the only way to get around this is to explicitly handle the collision,
manually applying <a class="css" data-link-type="propdesc" href="https://drafts.csswg.org/css-will-change-1/#propdef-will-change" id="ref-for-propdef-will-change③">will-change: transform, opacity</a> when the element matches both classes.
This sort of explicit collision-handling is unmaintainable,
and can quickly grow out of control if more cases are added,
as each one increases the number of combinations to be handled combinatorially.
(A third class means you need to explicitly handle the 1+2, 1+3, 2+3, and 1+2+3 cases.
A fourth class means handling 11 different combinations!)</p>
   <p>In this spec we propose a few possible mechanisms to handle these situations more elegantly.</p>
   <h2 class="heading settled" data-level="2" id="cascade-declarations"><span class="secno">2. </span><span class="content">Cascade Declarations</span><a class="self-link" href="#cascade-declarations"></a></h2>
   <p>During the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-4/#cascade" id="ref-for-cascade">cascade</a> process,
multiple declarations of the same property on a given element
are sorted in <a data-link-type="dfn" href="https://drafts.csswg.org/selectors-4/#specificity" id="ref-for-specificity">specificity</a> order
to produce the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-4/#output-of-the-cascade" id="ref-for-output-of-the-cascade">output of the cascade</a>,
and then only the last value
(the one with highest <span>specificity</span>)
is actually used as the value of that property on the element.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="cascade-modifier">cascade modifier</dfn> is a modifier on a property name
that makes the property’s value depend partially on the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="previous-cascaded-value">previous cascaded value</dfn>:
the value for that property that comes before the current value
(that is, is lower <a data-link-type="dfn" href="https://drafts.csswg.org/selectors-4/#specificity" id="ref-for-specificity②">specificity</a>)
in the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-4/#output-of-the-cascade" id="ref-for-output-of-the-cascade①">output of the cascade</a>.</p>
   <p>For any set-valued property with a name <a class="property" data-link-type="propdesc">set-prop</a>,
the following <a data-link-type="dfn" href="#cascade-modifier" id="ref-for-cascade-modifier">cascade modifiers</a> exist:</p>
   <dl>
    <dt data-md><dfn data-dfn-type="dfn" data-noexport id="set-prop">set-prop+<a class="self-link" href="#set-prop"></a></dfn>
    <dd data-md>
     <p>Represents the union of its value with the <a data-link-type="dfn" href="#previous-cascaded-value" id="ref-for-previous-cascaded-value">previous cascaded value</a>.</p>
    <dt data-md><dfn data-dfn-type="dfn" data-noexport id="set-prop①">set-prop-<a class="self-link" href="#set-prop①"></a></dfn>
    <dd data-md>
     <p>Represents the difference of the <a data-link-type="dfn" href="#previous-cascaded-value" id="ref-for-previous-cascaded-value①">previous cascaded value</a> with its value.
(That is, the <span>previous cascaded value</span>,
minus the current values.)</p>
    <dt data-md><dfn data-dfn-type="dfn" data-noexport id="set-prop②">set-prop{}<a class="self-link" href="#set-prop②"></a></dfn>
    <dd data-md>
     <p>Represents the intersection its value with the <a data-link-type="dfn" href="#previous-cascaded-value" id="ref-for-previous-cascaded-value③">previous cascaded value</a>.</p>
   </dl>
   <p class="issue" id="issue-b1da65fb"><a class="self-link" href="#issue-b1da65fb"></a> This involves defining the "unit" of each set-valued property
(for example, in <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-will-change-1/#propdef-will-change" id="ref-for-propdef-will-change④">will-change</a> each keyword is a "unit"),
and ensuring that all of them have a "null" value
(like <span class="css">none</span>).</p>
   <p>For any list-valued property with a name <a class="property" data-link-type="propdesc">list-prop</a>,
the following <a data-link-type="dfn" href="#cascade-modifier" id="ref-for-cascade-modifier①">cascade modifiers</a> exist:</p>
   <dl>
    <dt data-md><dfn data-dfn-type="dfn" data-noexport id="list-prop">list-prop+<a class="self-link" href="#list-prop"></a></dfn>
    <dd data-md>
     <p>Represents the current value appended to the end of the <a data-link-type="dfn" href="#previous-cascaded-value" id="ref-for-previous-cascaded-value④">previous cascaded value</a>.</p>
    <dt data-md><dfn data-dfn-type="dfn" data-noexport id="list-prop①">+list-prop<a class="self-link" href="#list-prop①"></a></dfn>
    <dd data-md>
     <p>Represents the current value prepended to the start of the <a data-link-type="dfn">previous cascade value</a>.</p>
   </dl>
   <p class="issue" id="issue-31f5b8d7"><a class="self-link" href="#issue-31f5b8d7"></a> The "unit" of list-valued properties are much easier to define;
for all but some legacy properties like <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-lists-3/#propdef-counter-reset" id="ref-for-propdef-counter-reset">counter-reset</a>,
it’s just splitting on commas.</p>
   <div class="issue" id="issue-4dfcacd8">
    <a class="self-link" href="#issue-4dfcacd8"></a> Define that, for all of these,
	we interpret the property as normal first,
	then split it into units for merging;
	this isn’t variable-style concatenation. 
    <p>That is, the following does <em>not</em> define a 2px-offset blue shadow:</p>
<pre class="lang-css highlight"><c- f>.foo </c-><c- p>{</c->
  box-shadow+: 2px 2px;
}
.foo {
  box-shadow+: blue;
}
</pre>
    <p>As each property is still interpreted <em>as a property</em>,
	the first is interpreted the same as <a class="css" data-link-type="propdesc" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-box-shadow" id="ref-for-propdef-box-shadow">box-shadow: 2px 2px;</a> (specifying a single drop-shadow set to <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-color-4/#valdef-color-currentcolor" id="ref-for-valdef-color-currentcolor">currentcolor</a>),
	while the second is simply invalid.</p>
   </div>
   <h3 class="heading settled" data-level="2.1" id="managing-order-explicitly-with-variables"><span class="secno">2.1. </span><span class="content">Managing Order Explicitly with Variables</span><a class="self-link" href="#managing-order-explicitly-with-variables"></a></h3>
   <p>Using <a data-link-type="dfn" href="#cascade-modifier" id="ref-for-cascade-modifier②">cascade modifiers</a> directly can achieve a number of useful, simple effects,
but direct usage doesn’t allow a number of common use-cases.
For example, you can’t <em>override</em> a particular <span>cascade modifier</span> with a more specific rule.</p>
   <div class="example" id="example-e6393f7b">
    <a class="self-link" href="#example-e6393f7b"></a> For example, take the following:
<pre class="lang-css highlight"><c- f>div </c-><c- p>{</c->
  <c- k>background-image</c-><c- p>:</c-> <c- nf>url</c-><c- p>(</c-><c- s>base.jpg</c-><c- p>);</c->
<c- p>}</c->
<c- f>div.foo </c-><c- p>{</c->
  +background-image: url(one.jpg);
}
div.foo.bar {
  +background-image: url(two.jpg);
}
</pre>
    <p>This does *not* override the <span class="css">one.jpg</span> with <span class="css">two.jpg</span>;
	for an element matching all three rules,
	it produces an equivalent effect to <a class="css" data-link-type="propdesc" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image" id="ref-for-propdef-background-image">background-image: url(two.jpg), url(one.jpg), url(base.jpg);</a>.</p>
    <p>In other words, so long as the element matches the <span class="css">div.foo</span> rule,
	the value will contain <span class="css">url(one.jpg)</span>.</p>
    <p>(You can override the <em>entire thing</em> with a higher-specificity declaration
	that doesn’t use a <a data-link-type="dfn" href="#cascade-modifier" id="ref-for-cascade-modifier④">cascade modifier</a>,
	but that overrides the <span class="css">base.jpg</span> too.
	There’s no way to directly override <em>just</em> one of the modified declarations.)</p>
   </div>
   <p>The preferred pattern to achieve this is to use a <a data-link-type="dfn" href="https://drafts.csswg.org/css-variables-1/#custom-property" id="ref-for-custom-property">custom property</a>:</p>
   <div class="example" id="example-60ac2eb2">
    <a class="self-link" href="#example-60ac2eb2"></a> To fix the previous example,
	so <span class="css">base.jpg</span> always applies
	but <span class="css">one.jpg</span> and <span class="css">two.jpg</span> apply based on specificity,
	you can write: 
<pre class="lang-css highlight"><c- f>div </c-><c- p>{</c->
  <c- k>background-image</c-><c- p>:</c-> <c- nf>url</c-><c- p>(</c-><c- s>base.jpg</c-><c- p>);</c->
  +background-image: var(--upper-background) !important;
}
div.foo {
  --upper-background: url(one.jpg);
}
div.foo.bar {
  --upper-background: url(two.jpg);
}
</pre>
   </div>
   <details class="note">
    <summary>Why not just use variables by themselves? Why the extra complexity?</summary>
    <p>The above example could instead be written only using variables,
	with no cascade controls:</p>
<pre class="lang-css highlight"><c- f>div </c-><c- p>{</c->
  <c- k>background-image</c-><c- p>:</c-> <c- nf>var</c-><c- p>(</c->--upper-background<c- p>,</c-> none<c- p>),</c-> <c- nf>url</c-><c- p>(</c-><c- s>base.jpg</c-><c- p>);</c->
<c- p>}</c->
<c- f>div.foo </c-><c- p>{</c->
  <c- k>--upper-background</c-><c- p>:</c-> <c- nf>url</c-><c- p>(</c-><c- s>one.jpg</c-><c- p>);</c->
<c- p>}</c->
<c- f>div.foo.bar </c-><c- p>{</c->
  <c- k>--upper-background</c-><c- p>:</c-> <c- nf>url</c-><c- p>(</c-><c- s>two.jpg</c-><c- p>);</c->
<c- p>}</c->
</pre>
    <p>While this works in simple situations,
	it’s less useful as more things interact.
	It requires that <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image" id="ref-for-propdef-background-image①">background-image</a> never be disturbed;
	if anything else attempts to set background-image,
	it’ll wipe out the variable use.
	The <a data-link-type="dfn" href="#cascade-modifier" id="ref-for-cascade-modifier⑤">cascade modifier</a> approach,
	on the other hand,
	maintains the images set by the variables
	even if other code sets the <span class="property">background-image</span> property.</p>
   </details>
   <h2 class="heading settled" data-level="3" id="cascade-function"><span class="secno">3. </span><span class="content">cascade() Function</span><a class="self-link" href="#cascade-function"></a></h2>
   <div class="issue" id="issue-a8710998"><a class="self-link" href="#issue-a8710998"></a> More directly but slightly more complex,
	we could add a cascade() function
	that’s accepted by all set-valued and list-values properties
	as a whole "unit".
	By default it subs in the <a data-link-type="dfn" href="#previous-cascaded-value" id="ref-for-previous-cascaded-value⑤">previous cascaded value</a> for itself,
	but for set-valued things it needs to offer more functionality to do difference/intersection. </div>
  </main>
  <h2 class="no-ref no-num heading settled" id="conformance"><span class="content"> Conformance</span><a class="self-link" href="#conformance"></a></h2>
  <h3 class="heading settled" id="document-conventions"><span class="content"> Document conventions</span><a class="self-link" href="#document-conventions"></a></h3>
  <p>Conformance requirements are expressed with a combination of
	descriptive assertions and RFC 2119 terminology. The key words “MUST”,
	“MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
	“RECOMMENDED”, “MAY”, and “OPTIONAL” in the normative parts of this
	document are to be interpreted as described in RFC 2119.
	However, for readability, these words do not appear in all uppercase
	letters in this specification. </p>
  <p>All of the text of this specification is normative except sections
	explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119">[RFC2119]</a> </p>
  <p>Examples in this specification are introduced with the words “for example”
	or are set apart from the normative text with <code>class="example"</code>,
	like this: </p>
  <div class="example" id="example-ae2b6bc0">
   <a class="self-link" href="#example-ae2b6bc0"></a>
   <p>This is an example of an informative example. </p>
  </div>
  <p>Informative notes begin with the word “Note” and are set apart from the
	normative text with <code>class="note"</code>, like this: </p>
  <p class="note" role="note">Note, this is an informative note. </p>
  <p>Advisements are normative sections styled to evoke special attention and are
	set apart from other normative text with <code>&lt;strong class="advisement"></code>, like
	this: <strong class="advisement"> UAs MUST provide an accessible alternative. </strong> </p>
  <h3 class="heading settled" id="conform-classes"><span class="content"> Conformance classes</span><a class="self-link" href="#conform-classes"></a></h3>
  <p>Conformance to this specification
	is defined for three conformance classes: </p>
  <dl>
   <dt>style sheet
   <dd>A <a href="http://www.w3.org/TR/CSS2/conform.html#style-sheet">CSS
			style sheet</a>.
   <dt>renderer
   <dd>A <a href="http://www.w3.org/TR/CSS2/conform.html#user-agent">UA</a> that interprets the semantics of a style sheet and renders
			documents that use them.
   <dt>authoring tool
   <dd>A <a href="http://www.w3.org/TR/CSS2/conform.html#user-agent">UA</a> that writes a style sheet.
  </dl>
  <p>A style sheet is conformant to this specification
	if all of its statements that use syntax defined in this module are valid
	according to the generic CSS grammar and the individual grammars of each
	feature defined in this module. </p>
  <p>A renderer is conformant to this specification
	if, in addition to interpreting the style sheet as defined by the
	appropriate specifications, it supports all the features defined
	by this specification by parsing them correctly
	and rendering the document accordingly. However, the inability of a
	UA to correctly render a document due to limitations of the device
	does not make the UA non-conformant. (For example, a UA is not
	required to render color on a monochrome monitor.) </p>
  <p>An authoring tool is conformant to this specification
	if it writes style sheets that are syntactically correct according to the
	generic CSS grammar and the individual grammars of each feature in
	this module, and meet all other conformance requirements of style sheets
	as described in this module. </p>
  <h3 class="heading settled" id="conform-responsible"><span class="content"> Requirements for Responsible Implementation of CSS</span><a class="self-link" href="#conform-responsible"></a></h3>
  <p>The following sections define several conformance requirements
		for implementing CSS responsibly,
		in a way that promotes interoperability in the present and future. </p>
  <h4 class="heading settled" id="conform-partial"><span class="content"> Partial Implementations</span><a class="self-link" href="#conform-partial"></a></h4>
  <p>So that authors can exploit the forward-compatible parsing rules to assign fallback values, <strong>CSS renderers <em>must</em> treat as invalid
		(and <a href="http://www.w3.org/TR/CSS2/conform.html#ignore">ignore as appropriate</a>)
		any at-rules, properties, property values, keywords, and other syntactic constructs
		for which they have no usable level of support</strong>.
		In particular, user agents <em>must not</em> selectively ignore
		unsupported property values and honor supported values in a single multi-value property declaration:
		if any value is considered invalid (as unsupported values must be),
		CSS requires that the entire declaration be ignored. </p>
  <h4 class="heading settled" id="conform-future-proofing"><span class="content"> Implementations of Unstable and Proprietary Features</span><a class="self-link" href="#conform-future-proofing"></a></h4>
  <p>To avoid clashes with future stable CSS features,
		the CSSWG recommends <a href="http://www.w3.org/TR/CSS/#future-proofing">following best practices</a> for the implementation of <a href="http://www.w3.org/TR/CSS/#unstable">unstable</a> features and <a href="http://www.w3.org/TR/CSS/#proprietary-extension">proprietary extensions</a> to CSS. </p>
  <h4 class="heading settled" id="conform-testing"><span class="content"> Implementations of CR-level Features</span><a class="self-link" href="#conform-testing"></a></h4>
  <p>Once a specification reaches the Candidate Recommendation stage,
		implementers should release an <a data-link-type="dfn" href="http://www.w3.org/TR/CSS/#vendor-prefix">unprefixed</a> implementation
		of any CR-level feature they can demonstrate
		to be correctly implemented according to spec,
		and should avoid exposing a prefixed variant of that feature. </p>
  <p>To establish and maintain the interoperability of CSS across
		implementations, the CSS Working Group requests that non-experimental
		CSS renderers submit an implementation report (and, if necessary, the
		testcases used for that implementation report) to the W3C before
		releasing an unprefixed implementation of any CSS features. Testcases
		submitted to W3C are subject to review and correction by the CSS
		Working Group. </p>
  <p>
   Further information on submitting testcases and implementation reports
		can be found from on the CSS Working Group’s website at <a href="http://www.w3.org/Style/CSS/Test/">http://www.w3.org/Style/CSS/Test/</a>.
		Questions should be directed to the <a href="http://lists.w3.org/Archives/Public/public-css-testsuite">public-css-testsuite@w3.org</a> mailing list.
<script src="https://www.w3.org/scripts/TR/2016/fixup.js"></script>
  </p>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#cascade-modifier">cascade modifier</a><span>, in §2</span>
   <li><a href="#list-prop①">+list-prop</a><span>, in §2</span>
   <li><a href="#list-prop">list-prop+</a><span>, in §2</span>
   <li><a href="#previous-cascaded-value">previous cascaded value</a><span>, in §2</span>
   <li><a href="#set-prop②">set-prop{}</a><span>, in §2</span>
   <li><a href="#set-prop">set-prop+</a><span>, in §2</span>
   <li><a href="#set-prop①">set-prop-</a><span>, in §2</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-propdef-background-image">
   <a href="https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image">https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-background-image">2.1. Managing Order Explicitly with Variables</a> <a href="#ref-for-propdef-background-image①">(2)</a> <a href="#ref-for-propdef-background-image②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-propdef-box-shadow">
   <a href="https://drafts.csswg.org/css-backgrounds-3/#propdef-box-shadow">https://drafts.csswg.org/css-backgrounds-3/#propdef-box-shadow</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-box-shadow">2. Cascade Declarations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-cascade">
   <a href="https://drafts.csswg.org/css-cascade-4/#cascade">https://drafts.csswg.org/css-cascade-4/#cascade</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-cascade">2. Cascade Declarations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-output-of-the-cascade">
   <a href="https://drafts.csswg.org/css-cascade-4/#output-of-the-cascade">https://drafts.csswg.org/css-cascade-4/#output-of-the-cascade</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-output-of-the-cascade">2. Cascade Declarations</a> <a href="#ref-for-output-of-the-cascade①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-valdef-color-currentcolor">
   <a href="https://drafts.csswg.org/css-color-4/#valdef-color-currentcolor">https://drafts.csswg.org/css-color-4/#valdef-color-currentcolor</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-valdef-color-currentcolor">2. Cascade Declarations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-propdef-opacity">
   <a href="https://drafts.csswg.org/css-color-4/#propdef-opacity">https://drafts.csswg.org/css-color-4/#propdef-opacity</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-opacity">1. Introduction</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-propdef-counter-reset">
   <a href="https://drafts.csswg.org/css-lists-3/#propdef-counter-reset">https://drafts.csswg.org/css-lists-3/#propdef-counter-reset</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-counter-reset">2. Cascade Declarations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-propdef-transform">
   <a href="https://drafts.csswg.org/css-transforms-1/#propdef-transform">https://drafts.csswg.org/css-transforms-1/#propdef-transform</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-transform">1. Introduction</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-custom-property">
   <a href="https://drafts.csswg.org/css-variables-1/#custom-property">https://drafts.csswg.org/css-variables-1/#custom-property</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-custom-property">2.1. Managing Order Explicitly with Variables</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-propdef-will-change">
   <a href="https://drafts.csswg.org/css-will-change-1/#propdef-will-change">https://drafts.csswg.org/css-will-change-1/#propdef-will-change</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-propdef-will-change">1. Introduction</a> <a href="#ref-for-propdef-will-change①">(2)</a> <a href="#ref-for-propdef-will-change②">(3)</a> <a href="#ref-for-propdef-will-change③">(4)</a>
    <li><a href="#ref-for-propdef-will-change④">2. Cascade Declarations</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-specificity">
   <a href="https://drafts.csswg.org/selectors-4/#specificity">https://drafts.csswg.org/selectors-4/#specificity</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-specificity">2. Cascade Declarations</a> <a href="#ref-for-specificity①">(2)</a> <a href="#ref-for-specificity②">(3)</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[css-backgrounds-3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-propdef-background-image" style="color:initial">background-image</span>
     <li><span class="dfn-paneled" id="term-for-propdef-box-shadow" style="color:initial">box-shadow</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-cascade-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-cascade" style="color:initial">cascade</span>
     <li><span class="dfn-paneled" id="term-for-output-of-the-cascade" style="color:initial">output of the cascade</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-color-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-valdef-color-currentcolor" style="color:initial">currentcolor</span>
     <li><span class="dfn-paneled" id="term-for-propdef-opacity" style="color:initial">opacity</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-lists-3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-propdef-counter-reset" style="color:initial">counter-reset</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-transforms-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-propdef-transform" style="color:initial">transform</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-variables-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-custom-property" style="color:initial">custom property</span>
    </ul>
   <li>
    <a data-link-type="biblio">[css-will-change-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-propdef-will-change" style="color:initial">will-change</span>
    </ul>
   <li>
    <a data-link-type="biblio">[selectors-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-specificity" style="color:initial">specificity</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-backgrounds-3">[CSS-BACKGROUNDS-3]
   <dd>Bert Bos; Elika Etemad; Brad Kemper. <a href="https://www.w3.org/TR/css-backgrounds-3/">CSS Backgrounds and Borders Module Level 3</a>. 17 October 2017. CR. URL: <a href="https://www.w3.org/TR/css-backgrounds-3/">https://www.w3.org/TR/css-backgrounds-3/</a>
   <dt id="biblio-css-cascade-4">[CSS-CASCADE-4]
   <dd>Elika Etemad; Tab Atkins Jr.. <a href="https://www.w3.org/TR/css-cascade-4/">CSS Cascading and Inheritance Level 4</a>. 14 January 2016. CR. URL: <a href="https://www.w3.org/TR/css-cascade-4/">https://www.w3.org/TR/css-cascade-4/</a>
   <dt id="biblio-css-color-4">[CSS-COLOR-4]
   <dd>Tab Atkins Jr.; Chris Lilley. <a href="https://www.w3.org/TR/css-color-4/">CSS Color Module Level 4</a>. 5 July 2016. WD. URL: <a href="https://www.w3.org/TR/css-color-4/">https://www.w3.org/TR/css-color-4/</a>
   <dt id="biblio-css-lists-3">[CSS-LISTS-3]
   <dd>Tab Atkins Jr.. <a href="https://www.w3.org/TR/css-lists-3/">CSS Lists and Counters Module Level 3</a>. 20 March 2014. WD. URL: <a href="https://www.w3.org/TR/css-lists-3/">https://www.w3.org/TR/css-lists-3/</a>
   <dt id="biblio-css-transforms-1">[CSS-TRANSFORMS-1]
   <dd>Simon Fraser; et al. <a href="https://www.w3.org/TR/css-transforms-1/">CSS Transforms Module Level 1</a>. 30 November 2017. WD. URL: <a href="https://www.w3.org/TR/css-transforms-1/">https://www.w3.org/TR/css-transforms-1/</a>
   <dt id="biblio-css-variables-1">[CSS-VARIABLES-1]
   <dd>Tab Atkins Jr.. <a href="https://www.w3.org/TR/css-variables-1/">CSS Custom Properties for Cascading Variables Module Level 1</a>. 3 December 2015. CR. URL: <a href="https://www.w3.org/TR/css-variables-1/">https://www.w3.org/TR/css-variables-1/</a>
   <dt id="biblio-css-will-change-1">[CSS-WILL-CHANGE-1]
   <dd>Tab Atkins Jr.. <a href="https://www.w3.org/TR/css-will-change-1/">CSS Will Change Module Level 1</a>. 3 December 2015. CR. URL: <a href="https://www.w3.org/TR/css-will-change-1/">https://www.w3.org/TR/css-will-change-1/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>. March 1997. Best Current Practice. URL: <a href="https://tools.ietf.org/html/rfc2119">https://tools.ietf.org/html/rfc2119</a>
   <dt id="biblio-selectors-4">[SELECTORS-4]
   <dd>Elika Etemad; Tab Atkins Jr.. <a href="https://www.w3.org/TR/selectors-4/">Selectors Level 4</a>. 2 February 2018. WD. URL: <a href="https://www.w3.org/TR/selectors-4/">https://www.w3.org/TR/selectors-4/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> This involves defining the "unit" of each set-valued property
(for example, in <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-will-change-1/#propdef-will-change">will-change</a> each keyword is a "unit"),
and ensuring that all of them have a "null" value
(like <span class="css">none</span>).<a href="#issue-b1da65fb"> ↵ </a></div>
   <div class="issue"> The "unit" of list-valued properties are much easier to define;
for all but some legacy properties like <a class="property" data-link-type="propdesc" href="https://drafts.csswg.org/css-lists-3/#propdef-counter-reset">counter-reset</a>,
it’s just splitting on commas.<a href="#issue-31f5b8d7"> ↵ </a></div>
   <div class="issue">
     Define that, for all of these,
	we interpret the property as normal first,
	then split it into units for merging;
	this isn’t variable-style concatenation. 
    <p>That is, the following does <em>not</em> define a 2px-offset blue shadow:</p>
<pre class="lang-css highlight"><c- f>.foo </c-><c- p>{</c->
  box-shadow+: 2px 2px;
}
.foo {
  box-shadow+: blue;
}
</pre>
    <p>As each property is still interpreted <em>as a property</em>,
	the first is interpreted the same as <a class="css" data-link-type="propdesc" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-box-shadow">box-shadow: 2px 2px;</a> (specifying a single drop-shadow set to <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-color-4/#valdef-color-currentcolor">currentcolor</a>),
	while the second is simply invalid.</p>
     <a href="#issue-4dfcacd8"> ↵ </a>
   </div>
   <div class="issue"> More directly but slightly more complex,
	we could add a cascade() function
	that’s accepted by all set-valued and list-values properties
	as a whole "unit".
	By default it subs in the <a data-link-type="dfn" href="#previous-cascaded-value">previous cascaded value</a> for itself,
	but for set-valued things it needs to offer more functionality to do difference/intersection. <a href="#issue-a8710998"> ↵ </a></div>
  </div>
  <aside class="dfn-panel" data-for="cascade-modifier">
   <b><a href="#cascade-modifier">#cascade-modifier</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-cascade-modifier">2. Cascade Declarations</a> <a href="#ref-for-cascade-modifier①">(2)</a>
    <li><a href="#ref-for-cascade-modifier②">2.1. Managing Order Explicitly with Variables</a> <a href="#ref-for-cascade-modifier③">(2)</a> <a href="#ref-for-cascade-modifier④">(3)</a> <a href="#ref-for-cascade-modifier⑤">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="previous-cascaded-value">
   <b><a href="#previous-cascaded-value">#previous-cascaded-value</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-previous-cascaded-value">2. Cascade Declarations</a> <a href="#ref-for-previous-cascaded-value①">(2)</a> <a href="#ref-for-previous-cascaded-value②">(3)</a> <a href="#ref-for-previous-cascaded-value③">(4)</a> <a href="#ref-for-previous-cascaded-value④">(5)</a>
    <li><a href="#ref-for-previous-cascaded-value⑤">3. cascade() Function</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>